#ifndef BUILD_QUICK_SHOW
#include <linux/i2c.h>
#include <linux/delay.h>
#else
#include <no_os/slab.h>
#include <timer.h>
#endif

#include "rtk_amp_interface.h"
#include <rtk_kdriver/rtk_gpio.h>
//*************************************************************
// PUBLIC FUNCTIONS
//*************************************************************
typedef struct
{
    unsigned char bDataLen;
    unsigned char bAddr;
    unsigned char bArray[4];
}NTP8918_REG;

static NTP8918_REG NTP8918_InitTbl[] =
{
    {1, 0x0B, {0x01}}, //RESET
    {1, 0x33, {0x03}}, // Soft Mute On Control
    {1, 0x34, {0x03}}, // PWM switching Off
    {1, 0x35, {0x06}}, // PWM Mask Reset
    {1, 0x0B, {0x01}}, // Soft Reset contorl
    {1, 0x02, {0x00}}, // MCLK 3.072(48)/2.8224(44.1) MHz
    {1, 0x7E, {0x03}}, // Enable coefficient write for ch1/ch2

    {4, 0x32, {0x09, 0x6A, 0x3A, 0xFA}},
    {4, 0x33, {0x09, 0x6A, 0x3A, 0xFA}},
    {4, 0x34, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x35, {0x10, 0x7C, 0x57, 0x14}},
    {4, 0x36, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x37, {0x02, 0x57, 0xD8, 0x06}},
    {4, 0x38, {0x03, 0x57, 0xD8, 0x06}},
    {4, 0x39, {0x02, 0x57, 0xD8, 0x06}},
    {4, 0x3A, {0x11, 0x7E, 0x24, 0xD1}},
    {4, 0x3B, {0x10, 0xFC, 0x57, 0x20}},
    {4, 0x3C, {0x10, 0x7E, 0x2B, 0x8A}},
    {4, 0x3D, {0x10, 0xFE, 0x2B, 0x8A}},
    {4, 0x3E, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x3F, {0x10, 0x7C, 0x57, 0x14}},
    {4, 0x40, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x41, {0x10, 0x7E, 0x28, 0x31}},
    {4, 0x42, {0x11, 0xFE, 0x28, 0x31}},
    {4, 0x43, {0x10, 0x7E, 0x28, 0x31}},
    {4, 0x44, {0x11, 0x7E, 0x24, 0xD1}},
    {4, 0x45, {0x10, 0xFC, 0x57, 0x20}},
    {4, 0x46, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x47, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x48, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x49, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x4A, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x4B, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x4C, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x4D, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x4E, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x4F, {0x20, 0x00, 0x00, 0x00}},

    {1, 0x7E, {0x00}}, // Disable coefficient write for ch1/ch2
    {1, 0x33, {0x00}}, // Soft Mute Off Control/ch2
    {1, 0x20, {0x9D}}, // Low band DRC threshold = -57.0 dB
    {1, 0x21, {0x01}}, // DRC Low band At/Rt
    {1, 0x22, {0x9D}}, // High band DRC threshold = 1.25 dB
    {1, 0x23, {0x01}}, // DRC High band At/Re
    {1, 0x26, {0x97}}, // Post band DRC threshold = 2.75 dB
    {1, 0x27, {0x41}}, // DRC Post band At/Re
    {1, 0x2A, {0x6A}}, // Sub band DRC threshold = -9.0 dB
    {1, 0x2B, {0x01}}, // DRC Sub band At/Re
    {1, 0x29, {0x11}}, // 2Band DRC mode enable
    {1, 0x2C, {0x00}}, // Sub band mode enable
    {1, 0x17, {0xAD}}, // channel 1 vol
    {1, 0x18, {0xAD}}, // channel 2 vol
    {1, 0x43, {0x02}}, // PWM Output mode (0x02 = DBTL mode / 0x00 = AD mode)
    {1, 0x3C, {0x76}}, // Prescaler Value CH12
    {1, 0x33, {0x03}}, // Soft Mute On Control/ch2
    {1, 0x7E, {0x03}}, // Enable coefficient write for ch1/ch2

    {4, 0x00, {0x10, 0x7F, 0x48, 0x6F}},
    {4, 0x01, {0x11, 0xFF, 0x48, 0x6F}},
    {4, 0x02, {0x10, 0x7F, 0x48, 0x6F}},
    {4, 0x03, {0x11, 0x7F, 0x48, 0x2F}},
    {4, 0x04, {0x10, 0xFE, 0x91, 0x60}},
    {4, 0x05, {0x10, 0x7F, 0x7F, 0x52}},
    {4, 0x06, {0x11, 0xFF, 0x7F, 0x52}},
    {4, 0x07, {0x10, 0x7F, 0x7F, 0x52}},
    {4, 0x08, {0x11, 0x7F, 0x7F, 0x12}},
    {4, 0x09, {0x10, 0xFE, 0xFF, 0x25}},
    {4, 0x0A, {0x11, 0x00, 0x0E, 0x95}},
    {4, 0x0B, {0x11, 0xFF, 0x7E, 0x1F}},
    {4, 0x0C, {0x10, 0x7E, 0xE3, 0xF5}},
    {4, 0x0D, {0x11, 0x7F, 0x7E, 0x1F}},
    {4, 0x0E, {0x10, 0xFF, 0x01, 0x1F}},
    {4, 0x0F, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x10, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x11, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x12, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x13, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x14, {0x11, 0x01, 0x97, 0x75}},
    {4, 0x15, {0x11, 0xEB, 0x07, 0x07}},
    {4, 0x16, {0x10, 0x68, 0x05, 0xD8}},
    {4, 0x17, {0x11, 0x6B, 0x07, 0x07}},
    {4, 0x18, {0x10, 0xEB, 0x34, 0xC1}},
    {4, 0x19, {0x10, 0x7F, 0x34, 0xD4}},
    {4, 0x1A, {0x11, 0xFD, 0xDF, 0x7E}},
    {4, 0x1B, {0x10, 0x7C, 0x95, 0x4B}},
    {4, 0x1C, {0x11, 0x7D, 0xDF, 0x7E}},
    {4, 0x1D, {0x10, 0xFB, 0xCA, 0x1F}},
    {4, 0x1E, {0x10, 0x7F, 0xF0, 0x3D}},
    {4, 0x1F, {0x11, 0xFF, 0x8A, 0x8E}},
    {4, 0x20, {0x10, 0x7F, 0x26, 0x49}},
    {4, 0x21, {0x11, 0x7F, 0x8A, 0x8E}},
    {4, 0x22, {0x10, 0xFF, 0x16, 0x86}},
    {4, 0x23, {0x11, 0x00, 0x40, 0x38}},
    {4, 0x24, {0x11, 0xFE, 0x4E, 0xAC}},
    {4, 0x25, {0x10, 0x7C, 0x38, 0x96}},
    {4, 0x26, {0x11, 0x7E, 0x4E, 0xAC}},
    {4, 0x27, {0x10, 0xFC, 0xB9, 0x05}},
    {4, 0x28, {0x10, 0x7F, 0xEE, 0xE9}},
    {4, 0x29, {0x11, 0xFA, 0x42, 0xC2}},
    {4, 0x2A, {0x10, 0x75, 0x75, 0x39}},
    {4, 0x2B, {0x11, 0x7A, 0x42, 0xC2}},
    {4, 0x2C, {0x10, 0xF5, 0x64, 0x22}},
    {4, 0x2D, {0x10, 0x7F, 0x52, 0x3B}},
    {4, 0x2E, {0x11, 0xFC, 0xDE, 0x64}},
    {4, 0x2F, {0x10, 0x7A, 0xA2, 0xB9}},
    {4, 0x30, {0x11, 0x7C, 0xDE, 0x64}},
    {4, 0x31, {0x10, 0xF9, 0xF4, 0xF4}},
    {4, 0x5C, {0x10, 0x7C, 0x54, 0x10}},
    {4, 0x5D, {0x11, 0xE6, 0x6D, 0xE0}},
    {4, 0x5E, {0x10, 0x54, 0x81, 0xBC}},
    {4, 0x5F, {0x11, 0x66, 0x6D, 0xE0}},
    {4, 0x60, {0x10, 0xD0, 0xD5, 0xCC}},
    {4, 0x61, {0x11, 0x2A, 0xF1, 0x4A}},
    {4, 0x62, {0x12, 0xA8, 0xCA, 0x14}},
    {4, 0x63, {0x11, 0x26, 0xD5, 0x14}},
    {4, 0x64, {0x11, 0x7C, 0x40, 0x30}},
    {4, 0x65, {0x10, 0xF8, 0xE4, 0xCA}},
    {4, 0x66, {0x10, 0x76, 0x88, 0x5C}},
    {4, 0x67, {0x11, 0xB2, 0xD5, 0x3F}},
    {4, 0x68, {0x10, 0x0F, 0xDA, 0x31}},
    {4, 0x69, {0x11, 0x32, 0xD5, 0x3F}},
    {4, 0x6A, {0x10, 0x86, 0x62, 0x8C}},
    {4, 0x6B, {0x11, 0x03, 0xCE, 0x44}},
    {4, 0x6C, {0x11, 0xAD, 0x84, 0x4D}},
    {4, 0x6D, {0x10, 0x4B, 0x5E, 0x49}},
    {4, 0x6E, {0x11, 0x2D, 0x84, 0x4D}},
    {4, 0x6F, {0x10, 0xD2, 0xFA, 0xD2}},
    {4, 0x70, {0x11, 0x10, 0x61, 0xD7}},
    {4, 0x71, {0x0F, 0xFA, 0x0B, 0x06}},
    {4, 0x72, {0x0E, 0x17, 0xBB, 0x06}},
    {4, 0x73, {0x0F, 0x7A, 0x0B, 0x06}},
    {4, 0x74, {0x0F, 0x8D, 0x64, 0xDD}},
    {4, 0x75, {0x11, 0x00, 0x30, 0xB9}},
    {4, 0x76, {0x11, 0xFF, 0x81, 0xF1}},
    {4, 0x77, {0x10, 0x7E, 0xA4, 0x25}},
    {4, 0x78, {0x11, 0x7F, 0x81, 0xF1}},
    {4, 0x79, {0x10, 0xFF, 0x05, 0x97}},

    {1, 0x7E, {0x08}}, // Enable APEQ settings

    {4, 0x00, {0x10, 0x00, 0x00, 0x00}},
    {4, 0x01, {0x10, 0x00, 0x00, 0x00}},
    {4, 0x02, {0x10, 0x00, 0x00, 0x00}},
    {4, 0x03, {0x10, 0x00, 0x00, 0x00}},
    {4, 0x04, {0x10, 0x00, 0x00, 0x00}},
    {4, 0x05, {0x10, 0x00, 0x00, 0x00}},
    {4, 0x06, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x07, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x08, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x09, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x0A, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x0B, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x0C, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x0D, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x0E, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x0F, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x10, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x11, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x12, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x13, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x14, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x15, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x16, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x17, {0x20, 0x00, 0x00, 0x00}},
    {4, 0x1F, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x20, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x21, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x22, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x23, {0x11, 0x00, 0x00, 0x00}},
    {4, 0x24, {0x11, 0x00, 0x00, 0x00}},

    {1, 0x7E, {0x00}}, // Disable coefficient write for ch1/ch2
    {1, 0x33, {0x00}}, // Soft Mute Off Control/ch2
    {1, 0x19, {0x04}}, // APEQ Path Option
    {1, 0x1A, {0x00}}, // APEQ1 At/Re time
    {1, 0x1B, {0x00}}, // APEQ2 At/Re time
    {1, 0x1C, {0x00}}, // APEQ3 At/Re time
    {1, 0x1D, {0x00}}, // APEQ4 At/Re time
    {1, 0x1E, {0x00}}, // APEQ5 At/Re time
    {1, 0x1F, {0x00}}, // APEQ6 At/Re time
    {1, 0x0E, {0x15}}, // CH1 BQ1 ~ BQ3 Enable
    {1, 0x0F, {0x15}}, // CH2 BQ1 ~ BQ3 Enable
    {1, 0x10, {0x07}}, // CH1 BQ4 ~ BQ6 Enable
    {1, 0x11, {0x07}}, // CH2 BQ4 ~ BQ6 Enable
    {1, 0x12, {0x55}}, // CH1 BQ7 ~ BQ10 Enable
    {1, 0x13, {0x55}}, // CH2 BQ7 ~ BQ10 Enable
    {1, 0x14, {0xF5}}, // CH1 BQ11 ~ BQ12 Enable
    {1, 0x15, {0xF5}}, // CH2 BQ11 ~ BQ12 Enable
    {1, 0x68, {0x60}}, // Phase Control
    {1, 0x24, {0x80}}, // RS DRC Enable
    {1, 0x25, {0x28}}, // Vrms Period for Low-Band
    {1, 0x4D, {0x28}}, // Vrms Period for High-Band
    {1, 0x4E, {0x28}}, // Vrms Period for Sub-Band
    {1, 0x4F, {0x1E}}, // Vrms Period for Post-Band
    {1, 0x2D, {0x0A}}, // Threshold Table Mapping
    {1, 0x07, {0xF1}}, // Vrms DRC Release Filter On

    {1, 0x00, {0x00}}, // Input Format
    {1, 0x01, {0x00}}, // General Serial Input Format
    {1, 0x38, {0x0B}}, // PWM Protection Control
    {1, 0x41, {0x1A}}, // MPW
    {1, 0x44, {0x0E}}, // D-BTL Control
    {1, 0x76, {0x70}}, // Monitor1 & Mornitor2
    {1, 0x03, {0x4E}}, // Mixer 00 = 0.0 dB
    {1, 0x04, {0x00}}, // Mixer 01 = -150 dB
    {1, 0x05, {0x00}}, // Mixer 10 = -150 dB
    {1, 0x06, {0x4E}}, // Mixer 11 = 0.0 dB
    {1, 0x3E, {0x01}}, // PWM Mapping 1A to 1A/1B
    {1, 0x3F, {0x1A}}, // PWM Mapping 1B to 1A/1B

    {1, 0x3D, {0x00}}, // WCK Synchronizing Control
    {1, 0x0C, {0xFF}}, // Master volume Control
    {1, 0x16, {0x00}}, // Master Fine Volume : 0 dB
    {1, 0x33, {0x00}}, // Soft Mute Off
    {1, 0x34, {0x00}}, // PWM output switching = CH1/2 ON
    {1, 0x35, {0x00}}, // PWM Mask = High
    {1, 0x39, {0xC3}},
};

void ntp8918_amp_reset(void)
{
    RTK_GPIO_PCBINFO_T pinInfo;
    int ret = 0;

    AMP_WARN("\n ntp8918_amp_reset\n");

    ret = rtk_gpio_get_pcb_info("PIN_AMP_RESET",&pinInfo);

    if(ret == 0){
        rtk_gpio_output(pinInfo.gid, 0);
        mdelay(1);
        rtk_gpio_output(pinInfo.gid, 1);
        mdelay(1);
    }
}

void ntp8918_func(int amp_i2c_id, unsigned short slave_addr)
{
    unsigned char data[24];
    unsigned char data_len;
    unsigned char index;

#if NTP8918_DEBUG
    unsigned char i;
#endif

    ntp8918_amp_reset();

    AMP_WARN("\nNTP8918 Initial Start\n");
    for(index = 0; index < (sizeof(NTP8918_InitTbl)/sizeof(NTP8918_REG)); index ++)
    {
        data[0] = NTP8918_InitTbl[index].bAddr;
        data_len = NTP8918_InitTbl[index].bDataLen;
        memcpy(&data[1],NTP8918_InitTbl[index].bArray,NTP8918_InitTbl[index].bDataLen);

#if NTP8918_DEBUG
        AMP_WARN("===write addr:0x%x len:%d===\n",data[0],data_len);
        for(i = 0 ; i < NTP8918_InitTbl[index].bDataLen; ++i)
            AMP_WARN("%x ", data[i]);

#endif
        if (i2c_master_send_ex_flag(amp_i2c_id, slave_addr , data, data_len+1 ,I2C_M_FAST_SPEED) < 0)
            AMP_ERR("program NTP8918 failed\n");

    }
}

int ntp8918_dump_all(const char *buf, int amp_i2c_id, unsigned short slave_addr)
{

    return 0;
}

int ntp8918_mute_set(int on_off, int amp_i2c_id,unsigned short slave_addr)
{
    unsigned char data[2] ={0};


    data[0] = NTP8918_SOFT_MUTE_REG;
    if(on_off){
        AMP_WARN("ntp8918 unmute amp\n");
        data[1] = 0x00;    //--unmute amp
    }
    else{
        AMP_WARN("ntp8918 mute amp\n");
        data[1] = 0x03;    //--mute amp
    }
    return i2c_master_send_ex(amp_i2c_id, slave_addr, data, 2); 
}

int ntp8918_param_set(unsigned char *data_wr, int amp_i2c_id, unsigned short slave_addr)
{

    unsigned char send_data[2] ={0};

    send_data[0] = data_wr[0];
    send_data[1] = data_wr[1];

    if ( i2c_master_send_ex(amp_i2c_id, slave_addr, &send_data[0], 2) < 0 ){
        AMP_ERR("I2C Write Reg:0x%x Data_H:0x%x failed\n",send_data[0],send_data[1]);
        return (-1);
    }
    else{
        AMP_WARN("Addr:0x%x Reg:0x%x Data:0x%x\n", slave_addr,send_data[0],send_data[1]);
    }

    return 0;
}

int ntp8918_param_get(unsigned char *reg, int amp_i2c_id, unsigned short slave_addr)
{
    int ret = 0;
    int result = 0;
    unsigned char addr[1] ={0};
    unsigned char data[1] ={0};

    //Read
    addr[0] = reg[0];
    if ( i2c_master_send_ex(amp_i2c_id, slave_addr, &addr[0], 1) < 0 ){
        AMP_ERR("I2C Write Address Reg:0x%x failed\n",addr[0]);
        return (-1);
    }

    result = i2c_master_recv_ex(amp_i2c_id,slave_addr,NULL,0,data,NTP8918_DATA_SIZE);

    if(result<0) {
        AMP_ERR("Read AMP REG:0x%x failed !! \n",*reg);
        return (-1);
    }

    AMP_WARN("Addr:0x%x Reg:0x%x Data:0x%x \n", slave_addr,addr[0],data[0]);
    return ret;
}
