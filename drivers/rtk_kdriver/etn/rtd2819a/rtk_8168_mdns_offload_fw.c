#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/moduleparam.h>
#include <linux/netdevice.h>
#include <linux/etherdevice.h>
#include <linux/delay.h>
#include <linux/interrupt.h>
#include <linux/dma-mapping.h>
#include <linux/pm_runtime.h>
#include <rtd_log/rtd_module_log.h>
#include <rtk_kdriver/io.h>
#include <linux/inetdevice.h>
#include <linux/netdevice.h>
#include "rtk_8168_def.h"
#include "rtk_8168_mdns_offload.h"
#include "rtk_8168_inc.h"
#include "rtk_8168_mdns_offload_fw.h"

static const unsigned short g_mdns_offloading_fw_patch_code[] =
{
 0x1308, 0xF133, 0xC35A, 0x7260, 0x1200, 0xF12F, 0xC234, 0x1B00, 0x9B4A,
 0x7326, 0x49B4, 0xF006, 0xC22E, 0x734A, 0x4834, 0x9B4A, 0xE005, 0xC229,
 0x734A, 0x48B4, 0x9B4A, 0x1A18, 0x3091, 0xC323, 0x746A, 0x49C4, 0xF003,
 0xEB3E, 0xE002, 0xEB93, 0x1401, 0xF118, 0x1A36, 0xC319, 0x746A, 0x49C4,
 0xF002, 0x0208, 0x3091, 0x49C4, 0xF003, 0xEB63, 0xE002, 0xEBA4, 0x1401,
 0xF10A, 0xC30C, 0x746A, 0x49C4, 0xF00A, 0x0A10, 0xE02A, 0xC302, 0xBB00,
 0x0E94, 0xE06E, 0x80FE, 0xC0FF, 0xD150, 0x1A26, 0x308A, 0x7322, 0x25B5,
 0x0B0E, 0x1C00, 0xEA7C, 0xC767, 0x4027, 0xF161, 0x1C00, 0xEA87, 0x1F32,
 0x308F, 0x1B08, 0xEA73, 0x7236, 0x7746, 0x1700, 0xF01C, 0xC35A, 0x401F,
 0xF103, 0x1F00, 0x9F46, 0x7744, 0x449F, 0x445F, 0xEA66, 0xC751, 0x4027,
 0xF14B, 0xE00F, 0x7BC0, 0xEA70, 0x7236, 0x0A20, 0x1B20, 0xEA5C, 0x0220,
 0x7644, 0x445E, 0x449E, 0xEA57, 0xC742, 0x4027, 0xF13C, 0x7236, 0x7742,
 0xC665, 0x4037, 0xF137, 0x674A, 0x49F7, 0xF15D, 0xC3EA, 0x1D00, 0x9D64,
 0x9D66, 0x9D6A, 0x9D6C, 0xC330, 0x9D7A, 0x9D7C, 0x020C, 0x0302, 0x1D08,
 0x1C00, 0xEA58, 0x0208, 0x9A6E, 0x7468, 0x49C4, 0xF003, 0x1F4A, 0xE002,
 0x1F36, 0x31F8, 0x9F70, 0x7468, 0x48C0, 0x48C3, 0x48C5, 0x9C68, 0x1F00,
 0x9F72, 0xC317, 0x9F60, 0x7236, 0x0214, 0xEA88, 0x0302, 0x49B0, 0xF005,
 0x6560, 0x6761, 0x446F, 0xE002, 0x7560, 0x49D7, 0xF00B, 0xC333, 0x756A,
 0x4855, 0x9D6A, 0xE006, 0xE1CE, 0x03E8, 0x01A0, 0xD150, 0xFFFF, 0xC329,
 0x7462, 0x1400, 0xF022, 0xC224, 0x7744, 0x9F60, 0x1700, 0xF019, 0x1F00,
 0x9F7A, 0x9F7C, 0x7746, 0x9F6E, 0x746A, 0x48C1, 0x48C2, 0x48C3, 0x9C6A,
 0x7236, 0x1D08, 0x316A, 0xC413, 0x7690, 0xC712, 0xEA22, 0xC210, 0xC40E,
 0x738E, 0xEA38, 0x1401, 0xF110, 0xE010, 0x1C00, 0x9C6A, 0xE075, 0xE1A5,
 0xE0C2, 0xA8C0, 0xE914, 0x7800, 0xD150, 0xCE80, 0x7802, 0xFF00, 0x0500,
 0x2F00, 0xE056, 0xC5F9, 0x76AA, 0x4861, 0x9EAA, 0x72B0, 0xEA3E, 0x49B0,
 0xF005, 0x6760, 0x6461, 0x447C, 0xE002, 0x7760, 0xC6EF, 0x4037, 0xF00E,
 0xC5E9, 0x72AE, 0xEA3F, 0x49B0, 0xF005, 0x6660, 0x6461, 0x4474, 0xE002,
 0x7660, 0x4037, 0xF002, 0xE039, 0xC3DC, 0x746A, 0x4842, 0x4843, 0x9C6A,
 0xC4D7, 0xC331, 0x759A, 0x1A01, 0x150F, 0xFC06, 0x4315, 0x756A, 0x41AA,
 0x9D6A, 0xE006, 0x0D10, 0x4315, 0x756C, 0x41AA, 0x9D6C, 0xEA29, 0x9D6E,
 0xC5C5, 0xEA06, 0x757A, 0x22D2, 0xC6C0, 0x0608, 0xA5B5, 0x757C, 0x0501,
 0x4035, 0xF003, 0x9D7C, 0xE7F2, 0x767A, 0x0601, 0x9E7A, 0x1D00, 0x9D7C,
 0xE022, 0x1D02, 0xC4B1, 0x316C, 0xE9F1, 0x0508, 0x76A0, 0x48E2, 0x9EA0,
 0x7290, 0xE9F3, 0x0304, 0x9B90, 0xE77D, 0x7BC0, 0xEA06, 0x9D6E, 0x757A,
 0x22D2, 0xC69F, 0x0608, 0xA5B5, 0x757C, 0x0501, 0x4035, 0xF002, 0xE005,
 0x767A, 0x0601, 0x9E7A, 0x1D00, 0x9D7C, 0xC593, 0xE9D4, 0xC591, 0x76A0,
 0x1600, 0xF14B, 0x76AA, 0x49E3, 0xF1D9, 0xC5E5, 0x76A6, 0x0601, 0x9EA6,
 0x76A2, 0x1602, 0xF106, 0x1E02, 0x9EA0, 0xE021, 0x6000, 0x7BD0, 0x1601,
 0xF102, 0xE7CA, 0x1600, 0xF002, 0xE7C7, 0x1E00, 0xC22B, 0xC3F6, 0xC4F6,
 0x7580, 0x1500, 0xF00E, 0xB405, 0xB406, 0xE99B, 0xB006, 0xB005, 0x1401,
 0xF008, 0x0602, 0xC4EA, 0xA526, 0x30DC, 0x0D01, 0xF1F4, 0xE7B2, 0xC5BE,
 0x1E01, 0x9EA0, 0x7420, 0x48CF, 0x7526, 0x49D0, 0xF104, 0x1A18, 0x308A,
 0xE004, 0x0404, 0x1A14, 0xE7FC, 0xC3B0, 0x9C68, 0xC30E, 0x3360, 0xE9C7,
 0xC30C, 0x1C20, 0x9C60, 0xE124, 0xCE80, 0x0084, 0xD150, 0xE914, 0xCD10,
 0x0708, 0x0060, 0x7000, 0xC0F0, 0xE72D, 0xC5F8, 0x76AA, 0xC39B, 0x726A,
 0x1C00, 0x1D00, 0x49A0, 0xF002, 0x0401, 0x2521, 0x0501, 0x1510, 0xF1FA,
 0x726C, 0x1D00, 0x49A0, 0xF002, 0x0401, 0x2521, 0x0501, 0x1510, 0xF1FA,
 0x9C64, 0x1400, 0xF102, 0xE062, 0xC383, 0x746A, 0x1D00, 0x49C0, 0xF106,
 0x2641, 0x0501, 0x1510, 0xF1FB, 0xE005, 0x48C0, 0x4325, 0x9C6A, 0xE010,
 0x746C, 0x1D10, 0x49C0, 0xF107, 0x2641, 0x0501, 0x1520, 0xF1FB, 0xE0E9,
 0x7800, 0x48C0, 0x32A8, 0x0A10, 0x4322, 0x9C6C, 0x1A00, 0x9A0E, 0x1A2A,
 0xC4BE, 0x768A, 0x49E4, 0xF002, 0x0214, 0x30D0, 0xC4F1, 0x040A, 0x1F00,
 0x1500, 0xF006, 0x0D01, 0x7280, 0x31FA, 0x0404, 0xE7FA, 0x7580, 0xC4AD,
 0x9D8C, 0xC4E4, 0x7282, 0x3097, 0xE968, 0x1C22, 0xC364, 0x766A, 0x49E4,
 0xF002, 0x0414, 0xC3A2, 0x3120, 0x9B80, 0x9B82, 0xC59D, 0x73AC, 0x0308,
 0x44B3, 0x4473, 0x9E84, 0x1E00, 0x9E86, 0xC295, 0x734A, 0x49B4, 0xF01B,
 0xC293, 0x1B16, 0x30D8, 0x1D10, 0x1C00, 0xE8E2, 0x1B26, 0x30D8, 0xE973,
 0xC38C, 0x9B0E, 0x1B00, 0x9B10, 0x1A3A, 0x3090, 0x7340, 0x9B12, 0xC305,
 0x9B14, 0xE028, 0xE067, 0x0045, 0xFF11, 0x11FF, 0xDD86, 0xCD08, 0xC2FF,
 0x1B1A, 0x30D8, 0x1D04, 0x1C00, 0xE8C8, 0x1B1E, 0x30D8, 0xE9B0, 0xE001,
 0xC3F1, 0x1A0E, 0x3090, 0x9B40, 0x1B00, 0x9B44, 0x9B4A, 0x1B01, 0x21B6,
 0x9B46, 0xC3E9, 0x9B48, 0x1A26, 0x3090, 0x7740, 0x449F, 0x445F, 0x1C14,
 0x31E3, 0x44A7, 0x4467, 0x0A16, 0x9C40, 0x1B00, 0x30D8, 0xC212, 0x764A,
 0x49E4, 0xF003, 0xE933, 0xE003, 0xE988, 0xE001, 0xC271, 0x1B06, 0x30D8,
 0x1D06, 0x1C00, 0xE89D, 0x49E4, 0xF004, 0xC3CB, 0xE003, 0xD150, 0xC367,
 0x9B0C, 0x1B26, 0x49E4, 0xF002, 0x0314, 0x30D8, 0x7260, 0x1E11, 0x2368,
 0x3116, 0xC259, 0x764A, 0x49E4, 0xF004, 0x1A16, 0x1B20, 0xE003, 0x1A1A,
 0x1B08, 0x3090, 0xE860, 0x49E4, 0xF003, 0x0220, 0xE002, 0x0208, 0x7744,
 0x449F, 0x445F, 0xE857, 0x4124, 0x9C46, 0x49E4, 0xF10A, 0x1A0E, 0x3090,
 0x1B14, 0x1C00, 0xE84E, 0x4124, 0x9C4A, 0xE002, 0xE037, 0xE8DF, 0x1D00,
 0x9DE0, 0xC435, 0x768A, 0x49E4, 0xF006, 0x7412, 0x4494, 0x4454, 0x0228,
 0xE004, 0x7410, 0x4494, 0x4454, 0x020E, 0x2321, 0x9EE2, 0x76E4, 0x486F,
 0x9EE4, 0x3002, 0x2406, 0x27A6, 0xF003, 0x23AA, 0xF002, 0x0001, 0x2006,
 0xC71F, 0x4038, 0xF802, 0x3807, 0xE8BE, 0x32F1, 0x1C01, 0x415C, 0x9BA4,
 0xE8B9, 0x72E4, 0x49AF, 0xF1FE, 0x2001, 0x2404, 0x98E4, 0x2003, 0xC20A,
 0x1B00, 0x9B4C, 0x9B54, 0x734A, 0x48B3, 0x9B4A, 0xE702, 0xC307, 0xBB00,
 0xD150, 0x0780, 0xCD70, 0x0008, 0x1800, 0x1284, 0x0C02, 0xA554, 0xA5DC,
 0x402F, 0xF105, 0x1400, 0xF1FA, 0x1C01, 0xE002, 0x1C00, 0xFF80, 0x49B0,
 0xF004, 0x0B01, 0xA1D3, 0xE003, 0x0B02, 0xA5D3, 0x3127, 0x3720, 0x0B02,
 0xA5D3, 0x3127, 0x3720, 0x1300, 0xF1FB, 0xFF80, 0x7322, 0x25B5, 0x1E18,
 0x30DE, 0x30D9, 0x7264, 0x1E11, 0x2368, 0x3116, 0xFF80, 0xA5D4, 0x4477,
 0x44B7, 0xAF9C, 0x0402, 0x402C, 0xF1FA, 0xFF80, 0xA5D4, 0xAFDC, 0x0402,
 0x402C, 0xF1FC, 0xFF80, 0x64C0, 0x1400, 0xF00B, 0x32A1, 0x25C6, 0x1303,
 0xF10B, 0x63C1, 0x48C6, 0x48C7, 0x445C, 0x31AB, 0xE7F4, 0x8CE0, 0x0601,
 0x0701, 0xE009, 0x64C0, 0x8CE0, 0x0601, 0x0701, 0x0A01, 0x1200, 0xF0E9,
 0xE7F9, 0xFF80, 0x1C00, 0xA154, 0xA19C, 0x1541, 0xF304, 0x155A, 0xF802,
 0x0520, 0x1641, 0xF304, 0x165A, 0xF802, 0x0620, 0x402E, 0xF106, 0x0401,
 0x1500, 0xF1F0, 0x1C01, 0xE002, 0x1C00, 0xFF80, 0x76A0, 0x0E01, 0x9EA0,
 0xFF80, 0x76A0, 0x0601, 0x9EA0, 0xFF80, 0x1B00, 0xA153, 0x1500, 0xF008,
 0x27D6, 0x1703, 0xF004, 0x30DD, 0x0301, 0xE7F8, 0x0301, 0x0301, 0x30DA,
 0xFF80, 0x1B00, 0xA193, 0x0301, 0x1600, 0xF002, 0xE7FC, 0x30DA, 0xFF80,
 0x7800, 0x7802, 0xC31B, 0x746E, 0x6580, 0x1500, 0xF004, 0x3125, 0x0401,
 0xE7FB, 0x3363, 0xFF80, 0xC311, 0x7560, 0x7560, 0xC6F1, 0x77C0, 0x39FD,
 0x23F1, 0xC6EE, 0xA577, 0xFF80, 0x1C00, 0xA1D4, 0xABDC, 0x0401, 0x4025,
 0xF1FC, 0xFF80, 0xD150, 0xD020, 0xE620, 0xC5FE, 0x76A4, 0x2263, 0xC7FC,
 0x31FC, 0xFF80, 0x7440, 0xC50F, 0x4025, 0xF10B, 0x7442, 0xC50C, 0x4025,
 0xF107, 0x7444, 0xC509, 0x4025, 0xF103, 0x1C01, 0xE002, 0x1C00, 0xFF80,
 0x3333, 0x0000, 0xFB00, 0xC7FD, 0x9F60, 0xC7FC, 0x9F62, 0xC7FB, 0x9F64,
 0xFF80, 0xC711, 0x9F60, 0xC710, 0x9F62, 0xC70F, 0x9F64, 0xC70E, 0x9F66,
 0xC70D, 0x9F68, 0xC70C, 0x9F6A, 0xC70B, 0x9F6C, 0xC70A, 0x9F6E, 0xFF80,
 0x02FF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFB00, 0x7440,
 0xC5F7, 0x4025, 0xF11F, 0x7442, 0xC5F4, 0x4025, 0xF11B, 0x7444, 0xC5F1,
 0x4025, 0xF117, 0x7446, 0xC5EE, 0x4025, 0xF113, 0x7448, 0xC5EB, 0x4025,
 0xF10F, 0x744A, 0xC5E8, 0x4025, 0xF10B, 0x744C, 0xC5E5, 0x4025, 0xF107,
 0x744E, 0xC5E2, 0x4025, 0xF103, 0x1C01, 0xE002, 0x1C00, 0xFF80, 0x7440,
 0xC50F, 0x4025, 0xF10B, 0x7442, 0xC50C, 0x4025, 0xF107, 0x7444, 0xC509,
 0x4025, 0xF103, 0x1C01, 0xE002, 0x1C00, 0xFF80, 0x0001, 0x005E, 0xFB00,
 0xC7FD, 0x9F60, 0xC7FC, 0x9F62, 0xC7FB, 0x9F64, 0xFF80, 0xC711, 0x9F60,
 0xC710, 0x9F62, 0xFF80, 0x7440, 0xC50B, 0x4025, 0xF107, 0x7442, 0xC508,
 0x4025, 0xF103, 0x1C01, 0xE002, 0x1C00, 0xFF80, 0x00E0, 0xFB00,
};



static const unsigned short * get_hw_mdns_offloading_patch_code(unsigned int *pLen)
{
	*pLen = sizeof(g_mdns_offloading_fw_patch_code) / sizeof(g_mdns_offloading_fw_patch_code[0]);
	return g_mdns_offloading_fw_patch_code;
}


static void rtl8168_mac_hw_mdns_offloading_patch(struct rtl8168_private *tp)
{
	unsigned int i	= 0;
	const unsigned short *fw_code = NULL;
	unsigned int fw_code_len = 0;
	unsigned int reg = 0;
	fw_code = get_hw_mdns_offloading_patch_code(&fw_code_len);
	if(!fw_code || !fw_code_len)
		return;
	eth_info("mdns fw code size:%u\n", fw_code_len);
	for(i = 0; i < fw_code_len; i++) {
		reg = ((i << 1) & 0x3FF) + 0xF800;
		r8168_mac_ocp_write(tp, 0xE440, i >> 9);
		r8168_mac_ocp_write(tp, reg, fw_code[i]);
	}
}



void rtl8168_mac_hw_mdns_offloading_setting(struct rtl8168_private *tp)
{
	/* (16) Patch code to share FIFO if need (Yang Chang-Shiuan's patch code and BPs) */
	rtl8168_mac_hw_mdns_offloading_patch(tp);
	r8168_mac_ocp_write(tp, 0xFC26, 0x8000);//set break point address 0x8000
	rtl8168_set_hw_mdns_offload_params(tp);
	r8168_mac_ocp_write(tp, 0xFC28, 0x0E91);//set break point address 0x0	
}

unsigned int rtl8168_get_hw_mdns_offload_passthrough_list_content_addr(struct rtl8168_private *tp)
{
	return OFFLOAD_PASSTHROUGH_LIST_CONTENT_ADDR;
}